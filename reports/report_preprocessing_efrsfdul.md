 
# ОТЧЕТ ПО ПРОЦЕССУ ПРЕДОБРАБОТКИ ДАННЫХ ДЛЯ АНАЛИЗА И ПОСТРОЕНИЯ МОДЕЛЕЙ
 
## ИСТОЧНИКИ ДАННЫХ ДЛЯ ПОСТРОЕНИЯ МОДЕЛЕЙ  
Необходимыми источниками данных для построения модели являются  
•	Данные MDM федерального ресурса:  
     a.	financialleasecontract - таблица контрактов MDM  
     b.	financialleasecontractlessees - таблица лизингополучателей MDM  
     c.	financialleasecontractlessors - таблица лизингодателей MDM  
     d.	financialleasecontractobject - таблица предметов лизинга MDM  
•	Классификатор имущества - справочник Федерального ресурса для расшифровки поля кода предметов лизинга   
•	Портфель, сформированный по данным из 1с   
•	Список различных типов договоров с контрагентами по данным 1с   
•	Данные target-class, сформированный https://jupytergit.vtb-leasing.com/modeling/datasets/target_classes   
•	Регистрационные данные контрагентов -  таблицы MDM egrul_regdata и egrip_regdata   
•	Данных о контрагентах из DM.BEHAVIOR_MODEL_DAILY.   


Последовательность предобработки данных:   
•	Чтение и формирование *.pkl файлов в каталог data/interm/external_pkl для дальнейшего использования.    
•	Предварительная обработка данных target-class    
•	Определение категории контрагента по данным из различных источников    
•	Операция очистки и предобработки данных Фед. ресурса  

  
Ниже подробно расписан каждый из шагов.     
 
## ЧТЕНИЕ ИСТОЧНИКОВ    
Для чтения данных необходимо запустить в файле src/data/mdm_create_pickle.ipynb следующие функции:  
•	extract_1c -  разархивация портфеля 1с и списка различных типов договоров с контрагентами по данным 1с  
•	read_codes_ext - чтение файла классификатора имущества, скаченного с сайта https://fedresurs.ru/helps/Sfacts/MessageContent_1.8.pdf?attempt=1  
•	read_target_ext – чтение файла target-class  
•	read_financialleasecontract_ext - таблица контрактов MDM  
•	read_financialleasecontractlessees_ext - таблица лизингополучателей MDM  
•	read_financialleasecontractlessors_ext - таблица лизингодателей MDM  
•	read_financialleasecontractobject_ext - таблица предметов лизинга MDM  
•	read_accounts_from_crm-  чтение данных о контрагентах из CRM   
•	read_regdata_from_mdm – чтение регистрационных данных таблиц MDM egrul_regdata и egrip_regdata  
•	read_clients_in_behavior_model_daily – чтение данных о контрагентах из DM.BEHAVIOR_MODEL_DAILY  

Данные сохраняются в pkl файлах в директории data/interm/external_pkl. 
 
## ПРЕДВАРИТЕЛЬНАЯ ОБРАБОТКА ДАННЫХ TARGET-CLASS   

Предварительная обработка данных target-class осуществляется автоматически в момент чтения данных (функция read_target_ext файла src/data/mdm_create_pickle.ipynb). Код предобработки находится в функции target_filter файла preprocessing/preprocessing_target.ipynb. Здесь и далее у всех ipynb файлов, если не указано иначе, корневой каталог src/mdm. 

Предобработка заключатся в следующем:  
•	Берутся записи с датой принятия решения по сделке позже 01 января 2020 года  
•	Берутся записи со значениями в поле «попадает в выборку» 'обе модели' и 'только фрод'  
•	Проверяется, что в рамках одного наименования сделки присутствует только один ИНН контрагента
•	Проверяется, что длина ИНН содержит 10 или 12 символов  
•	Формируется вспомогательный столбец «Приложение», равному порядковому номеру строки обработанного массива  
•	Незаполненные значения столбца ‘Метка кред дефолта’ проставляются данными 'экспертный_кред_дефолт'
Предобработанный файл сохраняется в data/interm/external_pkl/target_dataset.pkl. Из этих данных уже будут формироваться данные для моделей кред и фрод дефолта.  
 
## ОПРЕДЕЛЕНИЕ КАТЕГОРИИ КОНТРАГЕНТА ПО ДАННЫМ ИЗ РАЗЛИЧНЫХ ИСТОЧНИКОВ  

Для определения категории лизингополучателей необходимо запустить файл preprocessing/preprocessing_accounts.ipynb.  

Из источников 1с, VTBL_MSCRM.dbo.AccountBase, MDM_Main.dbo.egrip_regdata (egrul_regdata), target-class определяется категория контрагентов по консервативному сценарию.   

Наиболее приоритетным является статус прекращения действия по данным регистрирующих органов (таблицы MDM_Main.dbo.egrip_regdata и MDM_Main.dbo.egrul_regdata). Если по данным рег. органов выявлено одно из следующих статусов:  
•	В отношении юридического лица в деле о несостоятельности (банкротстве) введено внешнее управление  
•	В отношении юридического лица в деле о несостоятельности (банкротстве) введено наблюдение  
•	В отношении юридического лица возбуждено производство по делу о несостоятельности (банкротстве)  
•	Внесение записи о государственной регистрации юридического лица признано ошибочным по решению регистрирующего органа  
•	Находится в стадии ликвидации  
•	Регистрирующим органом принято решение о предстоящем исключении юридического лица из ЕГРЮЛ (наличие в ЕГРЮЛ сведений о юридическом лице, в отношении которых внесена запись о недостоверности)  
•	Регистрирующим органом принято решение о предстоящем исключении юридического лица из ЕГРЮЛ (недействующее юридическое лицо)  
•	Регистрирующим органом принято решение от 22.12.2017 № 22810 о предстоящем исключении юридического лица из ЕГРЮЛ(недействующее юридическое лицо).Опубликовано в журнале «Вестник государственной регистрации» от 27.12.2017 № 51  
•	Юридическое лицо находится в процессе реорганизации в форме присоединения к другому юридическому лицу  
•	Юридическое лицо признано несостоятельным (банкротом) и в отношении него открыто конкурсное производство,  
то контрагенту присвоится статус «Недействующая организация». 

Далее наиболее значимыми статусами являются данные CRM (VTBL_MSCRM.dbo.AccountBase):  
•	Черный список  
•	Недействующая организация,   
•	Четвёртая группа надежности  
•	Отказ УОБ  

Далее в порядке понижения приоритетов:  
•	Клиент в прошлом (расторжение) (по данным 1с), см ниже  
•	Метка дефолта (по данным target-class)  
•	Остальные статусы по данным 1с, см. ниже  
•	Если у контрагента не было заключено договора с "Компанией 1", то проставляется статус 'Не является нашим клиентом'.   

*Примечание:* Метка дефолта у контрагента по данным target-class выставляется, если имеется хотя бы одна метка фрод дефолта у договора с этим контрагентом для данных, попадающим во фрод, и/или метка имеется у кред дефолта у любого договора, который попадает в кредитную модель.  

### Порядок определения статуса контрагента по данным 1с  
У приложения лизинга могут быть следующие статусы:  
•	'Проект (принятие к управленческому учету)',   
•	'Не было передачи в лизинг',  
•	'Закрыт',  
•	'Страховой случай',   
•	'Расторгнут в связи со страховым случаем',  
•	'Расторгнут',  
•	'Подписан (вступил в силу)'.  

Статусы приложения берутся из портфеля 1с. По ним, если у контрагента есть хоть один договор со статусом 'Подписан (вступил в силу)' среди тех, по которым была передача в лизинг, то ему присваивается статус ‘Есть действующий договор(ы)'.  
 
Если у контрагента был хоть один договор со статусом 'Расторгнут' или 'Расторгнут в связи со страховым случаем' среди тех, по которым была передача в лизинг, но нет действующих договоров, то ему присваивается статус «Клиент в прошлом (расторжение»).  

Если у контрагента был хоть один договор со статусом 'Закрыт' или 'Страховой случай', но нет действующих или расторгнутых договоров, то ему присваивается статус ‘Клиент в прошлом’.  
 
Если статус приложения не заполнен у все договоров контрагента или равны 'Проект (принятие к управленческому учету)', либо не было ни одной передачи в лизинг, то таким контрагентам присвоится статус ‘Не было передачи в лизинг’.   

Дополнительно из 1с выгружены типы договоров со всеми контрагентами "Компании 1" (файл data/external/all_counteragent_1c.tar.gz), что позволило дополнить статусы следующими значениями:
•	'Был договор с покупателем',   
•	'Был договор по услугам',  
•	'Был договор купли-продажи',   
•	'Был договор обратного выкупа',   
•	'Был договор цессии'.    


**Таблица 1. Статусы контрагентов по данным 1с** 


|    | Статус_контрагента             |   Количество ИНН |       Доля, % |
|---:|:-------------------------------|-----------------:|--------------:|
|  0 | Был договор купли-продажи      |              191 |   0.13   |
|  1 | Был договор по услугам         |                6 |   0.004  |
|  2 | Был договор с покупателем      |            17387 |  12.22      |
|  3 | Был договор цессии             |                1 |   0.0007 |
|  4 | Есть действующий договор(ы)    |            24521 |  17.24      |
|  5 | Клиент в прошлом               |            60845 |  42.79      |
|  6 | Клиент в прошлом (расторжение) |             9653 |   6.78     |
|  7 | Не было передачи в лизинг      |            29571 |  20.8       |
|  8 | Всего                          |           142175 | 100           |

Дополнительно к статусу контрагента формируется признак is_in_bmd, показывающий наличие контрагента в DM.BEHAVIOR_MODEL_DAILY.   
Файл со сводной категорией контрагентов сохраняется в data/interm/accounts_status.pkl.  
 
## ОПЕРАЦИЯ ОЧИСТКИ И ПРЕДОБРАБОТКИ ДАННЫХ ФЕД. РЕСУРСА 
Для очистки и предобратки данных фед. ресурса необходимо запустить файл preprocessing/merge_and_clean.ipynb.  

В ходе первичной обработки таблиц фед ресурса проводятся следующие операции:  
•	Удаляются все строки, имеющие по несколько лизингодателей и лизингополучателей в одном договоре  
•	Строки с несколькими предметами лизинга на один договор удаляются таким образом, чтобы оставалась одна запись с приоритетом по транспортным средствам  
•	Обработка поля причин завершения с определением в одну из групп (см. ниже)    
•	Вычисление поля origin_by_message, объединяющее все записи, относящиеся к одному договору  
•	Вычислены поле num_pl_total – количество предметов лизинга в одном договоре  
•	В случае смены ИНН лизингополучателя по договору рассчитано поле cession_date, равное дате сообщения (new_kreditmessage_date) со сменой ИНН  

После соединения всех таблиц efrsfdul (см. выше ) по полю new_kreditmessage_number, предприняты меры по восстановлению данных:  
•	В случае отсутствия данных о лизингодателе, проставляется тот лизингодатель, который был найден в других сообщениях этого договора. Договоры, по которым лизингодатель не найден ни в одном из сообщений, оставляются и считаются за лизинговую компанию со скрытыми данными  
•	 В случае присутствия несколько лизингодателей в рамках одного договора, проставляется только один из них лизингодатель, чаще всего последний  
•	В случае отсутствия данных о предмете лизинга, проставляется тот предмет лизинга, который был найден в других сообщениях этого договора. Договоры, по которым предмет лизинга не найден ни в одном из сообщений, оставляются с незаполненными полями о предмете лизинга  
•	В случае отсутствия данных о лизингополучателе в записи завершения договора, лизингополучатель проставляется от предыдущего сообщения  
•	В случае отсутствия данных о лизингополучателе в сообщениях, кроме завершения, при условии, что во всех записях указан только один лизингополучатель, то он и проставляется. Если по этому договору была цессия, то такие записи удаляются и в дальнейшем анализе не участвуют  

### Определение причин завершения приложений 

Поле new_terminationleasing_reason в таблице financialleasecontract имеет текстовый формат. Его обработка позволила выделить следующие группы причин завершения приложений (поле reason):  
•	завершение   
•	расторгнут  
•	отмена  
•	страховой случай  
•	страховой случай (гибель/тотал)  
•	замена/перенайм/переуступка  
•	гибель/тотал  

И еще одна категория «определена цессия» была вычислена, как наличие передачи другому лизингополучателю.
Пример таких значений представлен в таблице 2.  
 

**Таблица 2. Примеры распарсивания причин закрытия договора** 

| new_kreditmessage_type     | new_leasingcontract_number | new_terminationleasing_reason                                                                                  | new_contract_status | reason                          |
| -------------------------- | -------------------------- | -------------------------------------------------------------------------------------------------------------- | ------------------- | ------------------------------- |
| StopFinancialLeaseContract | \*548-СПБ-\*                | Закрытие в связи с наступлением страхового случая "угон".                                                      | Архивный            | страховой случай                |
| StopFinancialLeaseContract | \*779-МСК-\*                 | расторжение договора в связи с ТОТАЛом                                                                         | Архивный            | гибель/тотал                    |
| StopFinancialLeaseContract | \*460-МСК-\*                 | ДЛ расторгнут, ТС изъят                                                                                        | Архивный            | расторгнут                      |
| StopFinancialLeaseContract | \*62/11111\*                 | В связи со страховым случаем (тотальная гибель Транспортного средства)                                         | Архивный            | страховой случай (гибель/тотал) |
| StopFinancialLeaseContract | \*9-0062\*                   | Данные по договору переданы ошибочно, договор не состоялся.ТС лизингополучателю не передавался.                | Архивный            | отмена                          |
| StopFinancialLeaseContract | \*3/17/\*                    | Замена стороны по договору лизинга.                                                                            | Архивный            | замена/перенайм/переуступка     |
| StopFinancialLeaseContract | \*58-\*                      | В связи с заключением соглашения об уступке прав по Договору лизинга №4458-А от 13.03.2019 г.                  | Архивный            | замена/перенайм/переуступка     |
| StopFinancialLeaseContract | \*-266/\*                    | В связи с досрочным выкупом                                                                                    | Архивный            | завершение                      |
| StopFinancialLeaseContract | \*003\*                      | Договор расторгнут 21.05.2021 в связи с конструктивной гибелью Предмета лизинга                                | Архивный            | гибель/тотал                    |
| StopFinancialLeaseContract | \*49\*                       | ДЛ не был реализован, клиент отказался от сделки                                                               | Архивный            | отмена                          |
| StopFinancialLeaseContract | \*1220/О\*                   | В связи с истечением срока действия Договора финансовой аренды (лизинга) № 131220/ОБ от «08» декабря 2020 года | Архивный            | завершение                      |
| StopFinancialLeaseContract | \*IA/MSC-01906/\*            | Досрочное закрытие договора финансовой аренды (лизинга), в связи со страховым случаем                          | Архивный            | страховой случай                |
|                            |                            |                                                                                                                |                     |                                 |


Предобработанные данные фед ресурса сохраняются в data/interm/merge_cleaned.pkl.
